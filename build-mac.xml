<?xml version="1.0" encoding="UTF-8"?>
<?eclipse.ant.import?>
<project basedir="MovieManager" default="jar" name="MeD's Movie Manager">
    
     <property name="app-name" value="MeD's MovieManager.app"/>
     <property name="jar-name" value="MovieManager.jar"/>
    <property name="bin" value="build/bin/"/>
    <property name="jar" value="build/jar"/>
    <property name="dist-mac" value="build/mac"/>
	  <path id="project.lib.path">
		<fileset dir="lib/">
		  <include name="**/*.jar"/>
		  <include name="*.jar"/>
		</fileset>
	  </path>

	  <path id="project.classpath">
		<pathelement path="${classes}"/>
		<path refid="project.lib.path"/>
	  </path>  
	  
	<target name="clean">
        <delete dir="build"/>
    </target>
    <target depends="clean" name="cleanall"/>
  
    <target name="compile">
    	<mkdir dir="${bin}"/>
        <echo message="${ant.project.name}: ${ant.file}"/>
        <javac debug="true" debuglevel="source,lines,vars" destdir="${bin}" source="1.4"  classpathref="project.classpath" target="1.4">
            <src path="source"/>

        </javac>
    </target>
  
    <target depends="compile" name="jar">
 		
    	<mkdir dir="${jar}"/>
    	<mkdir dir="${jar}/lib"/>
    	<copy todir="${jar}/lib">
    		<fileset dir="lib/"/>
    	</copy>

    	<mkdir dir="${jar}/LookAndFeels"/>
    	<copy todir="${jar}/LookAndFeels">
    		<fileset dir="LookAndFeels/"/>
    	</copy>
    	
    	<mkdir dir="${jar}/reports"/>
    	<copy todir="${jar}/reports">
    		<fileset dir="reports/"/>
    	</copy>

    	<copy file="MovieManager.tmx" todir="${jar}"/>
    	
    	<mkdir dir="${bin}/codecs"/>
    	<copy todir="${bin}/codecs">
    		<fileset dir="codecs"/>
    	</copy>

    	<mkdir dir="${bin}/images"/>
    	<copy todir="${bin}/images">
    		<fileset dir="images"/>
    	</copy>
    	
    	<mkdir dir="${bin}/queries"/>
    	<copy todir="${bin}/queries">
    		<fileset dir="queries"/>
    	</copy>
    	
    	<jar destfile="${jar}/MovieManager.jar" manifest="../Manifest.txt">
    		<fileset dir="${bin}"/>
    	</jar>
    </target>
    
    <target name="build-mac" depends="jar">
    	<property name="tempdir" value="${dist-mac}/temp.app"/>
	    <mkdir dir="${tempdir}"/>
	    <mkdir dir="${tempdir}/Contents"/>
	    <mkdir dir="${tempdir}/Contents/MacOS"/>
	    <mkdir dir="${tempdir}/Contents/Resources"/>
	    <mkdir dir="${tempdir}/Contents/Resources/Java"/>
   		<copy file="packaging/mac/JavaApplicationStub" todir="${tempdir}/Contents/MacOS"/>
		<copy file="packaging/mac/log4j.properties" todir="${tempdir}/Contents/Resources/Java"/>
		<copy file="MovieManager.tmx" todir="${tempdir}/Contents/Resources/Java"/>
    	<copy todir="${tempdir}/Contents/Resources/Java/reports">
    		<fileset dir="reports">
        		<include name="**/*"/>
   			</fileset>
		</copy>
		<exec executable="chmod">
			<arg line="755 ${tempdir}/Contents/MacOS/JavaApplicationStub"/>
		</exec>
 		<copy file="packaging/mac/Info.plist" todir="${tempdir}/Contents"/>
 		<copy file="packaging/mac/PkgInfo" todir="${tempdir}/Contents"/>
		<copy file="packaging/mac/MovieManager.icns" todir="${tempdir}/Contents/Resources"/>
    	<copy file="${jar}/${jar-name}" todir="${tempdir}/Contents/Resources/Java"/>
		<copy todir="${tempdir}/Contents/Resources/Java/lib">
    		<fileset dir="lib">
        		<include name="**/*.*"/>
   			</fileset>
		</copy>
		<copy todir="${tempdir}/Contents/Resources/Java/LookAndFeels">
    		<fileset dir="LookAndFeels">
        		<include name="**/*"/>
   			</fileset>
		</copy>
		<exec executable="/Developer/Tools/SetFile">
			<arg line=" -a B ${tempdir}"/>
		</exec>
		<delete dir="${dist-mac}/${app-name}"/>
		<move file="${tempdir}" tofile="${dist-mac}/${app-name}"/>
    </target>
    
    <target name="install-mac" depends="build-mac">
		<move file="${dist-mac}/${app-name}" tofile="/Applications/${app-name}"/>
        </target>
    
    <target name="dist-mac" depends="build-mac">
    	<copy file="../Changelog.txt" todir="${dist-mac}"/>
    	<fileset file="*.dmg" />
    	<delete file="${dist-mac}/MovieManager.dmg"/>
		<exec executable="hdiutil" failonerror="true">
			<arg value="create"/>
			<arg value="-srcfolder"/>
			<arg value="${dist-mac}/"/>
			<arg value="-fs"/>
			<arg value="HFS+"/>
			<arg value="-volname"/>
			<arg value="MeD's Movie Manager"/>
			<arg value="${dist-mac}/temp.dmg"/>
			<arg value="-ov"/>
		</exec>
    	<delete file="${dist-mac}/Readme.rtf"/>
    	<exec executable="hdiutil" failonerror="true">
    		<arg line="convert ${dist-mac}/temp.dmg -format UDZO -imagekey zlib-level=-9 -o ${dist-mac}/MovieManager.dmg -ov"/>
    	</exec>
    	<delete file="${dist-mac}/temp.dmg"/>
    </target>
    <target name="run-mac">
	    <exec executable="open">
			<arg line="${dist-mac}/"/>
		</exec>
 	 </target>
    
</project>
